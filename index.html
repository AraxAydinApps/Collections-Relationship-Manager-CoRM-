<!DOCTYPE html>
<html lang="tr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoRM - Giriş</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing:border-box; }
    .grid-bg{
      background-image:
        linear-gradient(rgba(39,39,42,.35) 1px, transparent 1px),
        linear-gradient(90deg, rgba(39,39,42,.35) 1px, transparent 1px);
      background-size: 56px 56px;
      animation: gridMove 18s linear infinite;
    }
    @keyframes gridMove { 0%{background-position:0 0} 100%{background-position:56px 56px} }
    .card{
      background:#121214; border:1px solid #27272a; border-radius:18px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,.55);
    }
    .inp{
      width:100%; padding:12px 14px; border-radius:12px;
      border:1px solid #27272a; background:#0b0b0d; color:#e4e4e7;
      outline:none;
    }
    .inp:focus{ border-color:#52525b; }
    .btn{
      width:100%; padding:12px 14px; border-radius:12px;
      background:#e4e4e7; color:#09090b; font-weight:800; letter-spacing:.06em;
    }
    .muted{ color:#a1a1aa; }
  </style>
</head>

<body class="h-full">
  <div class="min-h-full grid-bg flex items-center justify-center p-6" style="background:#09090b;">
    <div class="w-full max-w-md card p-8">
      <div class="text-center mb-7">
        <div class="text-3xl font-extrabold text-zinc-100">CoRM</div>
        <div class="text-xs tracking-[0.3em] uppercase muted mt-2">COLLECTIONS RELATIONSHIP MANAGER</div>
        <div class="text-sm muted mt-3">Tahsilatta Netlik ve Disiplin</div>
      </div>

      <form id="loginForm" class="space-y-4">
        <div>
          <div class="text-xs uppercase tracking-widest muted font-semibold mb-2">E-POSTA</div>
          <input id="email" class="inp" type="email" placeholder="ornek@sirket.com" autocomplete="email" required />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest muted font-semibold mb-2">ŞİFRE</div>
          <input id="password" class="inp" type="password" placeholder="••••••••" autocomplete="current-password" required />
        </div>

        <button id="btnLogin" class="btn" type="submit">GİRİŞ YAP</button>

        <div class="text-center text-xs muted pt-2">
          Demo/MVP — davranış kısıtları backend tarafından uygulanır.
        </div>
      </form>
    </div>

    <div id="loading" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center">
      <div class="text-center">
        <div class="inline-block w-8 h-8 border-2 border-zinc-600 border-t-zinc-200 rounded-full animate-spin mb-4"></div>
        <div class="text-sm text-zinc-300 tracking-widest uppercase">Doğrulanıyor...</div>
      </div>
    </div>
  </div>

<script>
const WEBAPP_URL = "/api/corm";
const SESSION_KEY = "corm_session";
const COOKIE_NAME = "corm_session";

/** Cookie shared between www + apex */
function setCookie(name, value, days){
  const maxAge = days * 24 * 60 * 60;
  document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; Domain=.arazad.xyz; SameSite=Lax; Secure`;
}
function delCookie(name){
  document.cookie = `${name}=; Max-Age=0; Path=/; Domain=.arazad.xyz; SameSite=Lax; Secure`;
}

async function apiPost(payload){
  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload),
  });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}
function setLoading(on){
  const el = document.getElementById("loading");
  el.classList.toggle("hidden", !on);
  el.classList.toggle("flex", on);
}

document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const email = document.getElementById("email").value.trim().toLowerCase();
  const password = document.getElementById("password").value;

  try{
    setLoading(true);
    const r = await apiPost({ action:"login", email, password });
    if(!r.ok) throw new Error(r.error || "Login failed");

    const sessionObj = JSON.stringify({ token: r.token, user: r.user });

    // ✅ store in BOTH localStorage + cookie (cookie survives www/apex switch)
    localStorage.setItem(SESSION_KEY, sessionObj);
    setCookie(COOKIE_NAME, sessionObj, 7);

    // go to dosyalar on same origin
    location.href = "/dosyalar.html";
  }catch(err){
    alert("❌ " + (err.message || err));
  }finally{
    setLoading(false);
  }
});
</script>
</body>
</html>
