<!DOCTYPE html>
<html lang="tr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CoRM - Dosyalar</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ✅ Config from root (Vercel serves it) -->
  <script src="/corm_config.js"></script>

  <style>
    body { box-sizing:border-box; }

    .sel, .inp{
      background:#111113; border:1px solid #27272a; color:#e4e4e7;
      padding:10px 12px; border-radius:10px; font-size:13px; outline:none;
    }
    .sel:focus, .inp:focus{ border-color:#52525b; }

    .btn{
      background:#e4e4e7; color:#09090b; border-radius:10px;
      padding:10px 14px; font-weight:700; font-size:13px;
    }
    .btn2{
      background:#18181b; color:#e4e4e7; border:1px solid #27272a; border-radius:10px;
      padding:10px 14px; font-weight:700; font-size:13px;
    }

    .card{
      background:#121214; border:1px solid #27272a; border-radius:16px;
      padding:18px; cursor:pointer; transition:transform .08s ease, border-color .2s ease;
    }
    .card:hover{ transform: translateY(-1px); border-color:#3f3f46; }

    .stageDot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .s-ilk{ background:#22c55e; }
    .s-soz{ background:#eab308; }
    .s-bozuldu{ background:#f97316; }
    .s-cerceve{ background:#dc2626; }
    .s-x{ background:#71717a; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .toggle{ display:inline-flex; align-items:center; gap:10px; }
    .switch{ position:relative; width:44px; height:24px; background:#27272a; border:1px solid #3f3f46; border-radius:999px; cursor:pointer; }
    .knob{ position:absolute; top:3px; left:3px; width:18px; height:18px; border-radius:999px; background:#a1a1aa; transition:left .18s ease, background .18s ease; }
    .switch.on{ background:#dc2626; border-color:#ef4444; }
    .switch.on .knob{ left:23px; background:#fff; }

    .divider{ height:1px; background:#27272a; margin:14px 0; }
    .sectionTitle{ font-size:11px; color:#a1a1aa; text-transform:uppercase; letter-spacing:.12em; font-weight:700; }
  </style>
</head>

<body class="h-full">
  <div class="min-h-full w-full" style="background:#09090b;">
    <div class="max-w-6xl mx-auto px-6 py-8">

      <div class="flex items-start justify-between gap-4 mb-6">
        <div>
          <h1 class="text-3xl font-bold text-zinc-100">Dosyalar</h1>
          <div id="who" class="text-sm text-zinc-400 mt-1">—</div>
        </div>
        <div class="flex items-center gap-3">
          <button id="btnLogout" class="btn2">Çıkış</button>
        </div>
      </div>

      <div class="rounded-2xl border border-zinc-800 bg-zinc-950/40 p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">

          <div class="md:col-span-2">
            <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Aşama</div>
            <select id="fStage" class="sel w-full">
              <option value="">Tümü</option>
              <option value="ilk">İlk Hatırlatma</option>
              <option value="soz">Söz Alındı</option>
              <option value="bozuldu">Söz Bozuldu</option>
              <option value="cerceve">Çerçeve</option>
              <option value="x">X Süreci</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Sorumlu</div>
            <select id="fOwner" class="sel w-full">
              <option value="">Tümü</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Söz Bozuldu</div>
            <select id="fBroken" class="sel w-full">
              <option value="">Tümü</option>
              <option value="1">Evet</option>
              <option value="0">Hayır</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Gecikmiş</div>
            <div class="toggle">
              <div id="tOverdue" class="switch"><div class="knob"></div></div>
              <div class="text-sm text-zinc-400">Sadece gecikmiş</div>
            </div>
          </div>

          <div class="md:col-span-3">
            <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Arama</div>
            <input id="fSearch" class="inp w-full" placeholder="Firma / hesap kodu / tip / grup / sorumlu / aşama" />
          </div>

          <div class="md:col-span-1">
            <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Sıralama</div>
            <select id="fSort" class="sel w-full">
              <option value="priority">Öncelik</option>
              <option value="name">İsim</option>
              <option value="balance">Bakiye</option>
              <option value="overdue">Geciken</option>
              <option value="debt">Borç</option>
              <option value="credit">Alacak</option>
            </select>
          </div>
        </div>

        <div class="flex items-center justify-between mt-4">
          <div id="total" class="text-sm text-zinc-400">Toplam: —</div>
          <div class="flex items-center gap-2">
            <button id="btnNewCase" class="btn2">YENİ DOSYA</button>
            <button id="btnNewCollector" class="btn2">YENİ TAHSİLATÇI</button>
            <button id="btnRefresh" class="btn">Yenile</button>
          </div>
        </div>
      </div>

      <div id="grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

      <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 px-5 py-3 rounded-xl border border-zinc-700 bg-zinc-900 text-zinc-200 text-sm hidden"></div>
    </div>
  </div>

  <!-- NEW CASE MODAL -->
  <div id="modalNewCase" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
    <div class="w-full max-w-3xl rounded-2xl border border-zinc-700 bg-zinc-950 p-5">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xl font-bold text-zinc-100">Yeni Dosya (Case Oluştur)</div>
          <div class="text-sm text-zinc-400 mt-1">Sadece ana admin yeni dosya oluşturabilir.</div>
        </div>
        <button id="btnCloseNewCase" class="btn2">Kapat</button>
      </div>

      <div class="divider"></div>
      <div class="sectionTitle mb-3">MÜŞTERİ VERİSİ (CUSTOMER COLUMNS)</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <!-- Customer columns in order -->
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Hesap Kodu</div>
          <input id="nc_account_code" class="inp w-full" placeholder="120.01.999" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Hesap Adı</div>
          <input id="nc_account_name" class="inp w-full" placeholder="Firma Adı" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Tip Kodu</div>
          <input id="nc_type_code" class="inp w-full" placeholder="Tip Kodu" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Grup Kodu</div>
          <input id="nc_group_code" class="inp w-full" placeholder="Grup Kodu" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Borç Tutar</div>
          <input id="nc_debt_amount" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Alacak Tutar</div>
          <input id="nc_credit_amount" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Bakiye</div>
          <input id="nc_balance" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Müşteri Çek/Senet Riski</div>
          <input id="nc_customer_risk" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Kendi Çek/Senet Riski</div>
          <input id="nc_own_risk" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Borç Ort. Vade (gün)</div>
          <input id="nc_avg_debt_maturity" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Alacak Ort. Vade (gün)</div>
          <input id="nc_avg_credit_maturity" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Bakiye Ort. Vade (gün)</div>
          <input id="nc_avg_balance_maturity" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Alacak Tahsil Süresi (gün)</div>
          <input id="nc_avg_collection_time" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Son Tahsilat Tarihi</div>
          <input id="nc_last_collection_date" type="date" class="inp w-full" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Son Tahsilat Tutarı</div>
          <input id="nc_last_collection_amount" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Son Tahsilat İşlem Tipi</div>
          <input id="nc_last_collection_type" class="inp w-full" placeholder="EFT / Nakit / ..." />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Son 30 Gün Satış</div>
          <input id="nc_last_30d_sales" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Son Tahsilat Geçen Gün</div>
          <input id="nc_days_since_last_collection" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">E-Posta</div>
          <input id="nc_email" class="inp w-full" placeholder="mail@firma.com" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Geciken Bakiye Bekleme Süresi (gün)</div>
          <input id="nc_overdue_wait_days" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Geciken Bakiye</div>
          <input id="nc_overdue_balance" class="inp w-full" placeholder="-1000 (gecikmiş)" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Son Ödeme Geçen Gün</div>
          <input id="nc_days_since_last_payment" class="inp w-full" placeholder="0" />
        </div>
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Son Ödeme Tutarı</div>
          <input id="nc_last_payment_amount" class="inp w-full" placeholder="0" />
        </div>
      </div>

      <div class="divider"></div>
      <div class="sectionTitle mb-3">SİSTEM ALANLARI (PROGRAMMING COLUMNS)</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Collector (Owner)</div>
          <select id="nc_owner_user_id" class="sel w-full">
            <option value="">Yükleniyor...</option>
          </select>
        </div>

        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Due Date</div>
          <input id="nc_due_date" type="date" class="inp w-full" />
        </div>

        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Phone</div>
          <input id="nc_phone" class="inp w-full" placeholder="05xx..., +90..." />
        </div>

        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Postpone Limit</div>
          <input id="nc_postpone_limit" class="inp w-full" placeholder="2" />
        </div>
      </div>

      <div class="flex items-center justify-end gap-2 mt-5">
        <button id="btnCreateCase" class="btn">Oluştur + SMS Gönder</button>
      </div>

      <div class="text-xs text-zinc-500 mt-3 leading-relaxed">
        Not: Oluşturulduğunda CASES sheet'e kayıt edilir ve borçluya SMS gider.
        <br/>sms_state = <span class="mono text-zinc-300">NEW</span> , is_paid = <span class="mono text-zinc-300">FALSE</span>
      </div>
    </div>
  </div>

  <!-- NEW COLLECTOR MODAL -->
  <div id="modalNewCollector" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50">
    <div class="w-full max-w-xl rounded-2xl border border-zinc-700 bg-zinc-950 p-5">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xl font-bold text-zinc-100">Yeni Tahsilatçı Oluştur</div>
          <div class="text-sm text-zinc-400 mt-1">Sadece ana admin tahsilatçı ekleyebilir.</div>
        </div>
        <button id="btnCloseNewCollector" class="btn2">Kapat</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
        <div class="md:col-span-2">
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Ad Soyad</div>
          <input id="nu_full_name" class="inp w-full" placeholder="Örn: Ahmet Yılmaz" />
        </div>

        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">E-posta</div>
          <input id="nu_email" class="inp w-full" placeholder="ornek@firma.com" />
        </div>

        <div>
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Telefon</div>
          <input id="nu_phone" class="inp w-full" placeholder="05xx..., +90..." />
        </div>

        <div class="md:col-span-2">
          <div class="text-xs uppercase tracking-widest text-zinc-500 mb-2 font-semibold">Team</div>
          <input id="nu_team" class="inp w-full" placeholder="Örn: TeamA (boşsa oturum team'i)" />
        </div>
      </div>

      <div class="flex items-center justify-end gap-2 mt-5">
        <button id="btnCreateCollector" class="btn">Oluştur</button>
      </div>

      <div class="text-xs text-zinc-500 mt-3 leading-relaxed">
        Not: Kullanıcı rolü otomatik <span class="mono text-zinc-300">collector</span> olur.
        <br/>Şifre: Sistem otomatik üretir ve SMS ile gönderir.
      </div>
    </div>
  </div>

<script>
(function forceWww(){
  if (location.hostname === "arazad.xyz") {
    location.replace("https://www.arazad.xyz" + location.pathname + location.search + location.hash);
  }
})();

function resolveUrl(maybeUrl, fallback){
  const v = (maybeUrl || "").toString().trim();
  const use = v || fallback;
  if (/^https?:\/\//i.test(use)) return use;
  return new URL(use, window.location.origin).toString();
}

/** CONFIG (from corm_config.js) */
const WEBAPP_URL   = resolveUrl(window.CORM_WEBAPP_URL, "/api/corm");
const DETAIL_PAGE  = "/dosyadetayi.html";
const LOGIN_PAGE   = (window.CORM_LOGIN_PAGE || "/index.html");
const SESSION_KEY  = "corm_session";

let session = null;
let allCases = [];

const $ = (id) => document.getElementById(id);

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.remove("hidden");
  setTimeout(()=>t.classList.add("hidden"), 2500);
}

function loadSession(){
  try {
    const raw = localStorage.getItem(SESSION_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch { return null; }
}
function clearSession(){
  try { localStorage.removeItem(SESSION_KEY); } catch {}
  session = null;
}

async function apiPost(payload){
  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload),
  });
  if (!res.ok) throw new Error("HTTP " + res.status);
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { throw new Error("Non-JSON response: " + text.slice(0,180)); }
}

async function loadCases(){
  const u = session.user;
  const data = await apiPost({ action:"listCases", user_id:u.user_id, role:u.role, team:u.team, token: session.token });
  if (!data.ok) throw new Error(data.error || "listCases failed");
  allCases = data.cases || [];
}

function isMainAdmin(){
  return session?.user?.role === "admin";
}

/** modals */
function openModal(id){
  const m = $(id);
  m.classList.remove("hidden");
  m.classList.add("flex");
}
function closeModal(id){
  const m = $(id);
  m.classList.add("hidden");
  m.classList.remove("flex");
}

async function loadCollectorsIntoSelect(){
  const sel = $("nc_owner_user_id");
  sel.innerHTML = `<option value="">Yükleniyor...</option>`;
  const u = session.user;

  const data = await apiPost({
    action:"listCollectors",
    user_id:u.user_id, role:u.role, team:u.team, token: session.token
  });

  if (!data.ok) throw new Error(data.error || "listCollectors failed");

  const list = data.collectors || [];
  sel.innerHTML = `<option value="">Seçiniz</option>` + list.map(x =>
    `<option value="${String(x.user_id)}">${String(x.full_name)} (${String(x.user_id)})</option>`
  ).join("");
}

/** UI helpers */
function stageLabel(stage){
  const s = String(stage||"").toLowerCase();
  if (s==="ilk") return "İlk Hatırlatma";
  if (s==="soz") return "Söz Alındı";
  if (s==="bozuldu") return "Söz Bozuldu";
  if (s==="cerceve") return "Çerçeve";
  if (s==="x") return "X Süreci";
  return s || "-";
}
function stageDotClass(stage){
  const s = String(stage||"").toLowerCase();
  if (s==="ilk") return "s-ilk";
  if (s==="soz") return "s-soz";
  if (s==="bozuldu") return "s-bozuldu";
  if (s==="cerceve") return "s-cerceve";
  if (s==="x") return "s-x";
  return "s-x";
}
function num(n){
  const x = Number(n);
  return Number.isFinite(x) ? x : 0;
}
function moneyTRY(n){
  const v = num(n);
  return "₺" + v.toLocaleString("tr-TR");
}
function isOverdue(c){
  // "Geciken Bakiye" convention: negative means overdue (same as your existing logic)
  return num(c.overdue_balance) < 0;
}

function buildOwnerFilter(){
  const map = new Map();
  allCases.forEach(c => {
    const id = String(c.owner_user_id || "").trim();
    if (!id) return;
    const name = String(c.owner_name || "").trim() || id;
    if (!map.has(id)) map.set(id, name);
  });

  const sel = $("fOwner");
  const items = [...map.entries()].map(([id,name])=>({id,name}))
    .sort((a,b)=>a.name.localeCompare(b.name,"tr"));

  sel.innerHTML = `<option value="">Tümü</option>` +
    items.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
}

function applyFilters(){
  const fStage = $("fStage").value.trim().toLowerCase();
  const fOwner = $("fOwner").value.trim();
  const fBroken = $("fBroken").value.trim();
  const fSearch = $("fSearch").value.trim().toLowerCase();
  const onlyOverdue = $("tOverdue").classList.contains("on");
  const sort = $("fSort").value;

  let list = [...allCases];

  if (fStage) list = list.filter(c => String(c.stage||"").toLowerCase() === fStage);
  if (fOwner) list = list.filter(c => String(c.owner_user_id||"").trim() === fOwner);

  // still backend-driven
  if (fBroken === "1") list = list.filter(c => num(c.broken_promise_count) > 0);
  if (fBroken === "0") list = list.filter(c => num(c.broken_promise_count) <= 0);

  if (onlyOverdue) list = list.filter(c => isOverdue(c));

  if (fSearch){
    list = list.filter(c => {
      const a = String(c.account_name||"").toLowerCase();     // Hesap Adı
      const b = String(c.account_code||"").toLowerCase();     // Hesap Kodu
      const t = String(c.type_code||"").toLowerCase();        // Tip Kodu
      const g = String(c.group_code||"").toLowerCase();       // Grup Kodu
      const s = String(c.stage||"").toLowerCase();            // stage (system)
      const o = String(c.owner_name||"").toLowerCase();       // owner (system)
      return a.includes(fSearch) || b.includes(fSearch) || t.includes(fSearch) || g.includes(fSearch) || s.includes(fSearch) || o.includes(fSearch);
    });
  }

  if (sort === "name"){
    list.sort((a,b)=> String(a.account_name||"").localeCompare(String(b.account_name||""),"tr"));
  } else if (sort === "balance"){
    list.sort((a,b)=> Math.abs(num(b.balance)) - Math.abs(num(a.balance)));
  } else if (sort === "overdue"){
    list.sort((a,b)=> Math.abs(num(b.overdue_balance)) - Math.abs(num(a.overdue_balance)));
  } else if (sort === "debt"){
    list.sort((a,b)=> Math.abs(num(b.debt_amount)) - Math.abs(num(a.debt_amount)));
  } else if (sort === "credit"){
    list.sort((a,b)=> Math.abs(num(b.credit_amount)) - Math.abs(num(a.credit_amount)));
  } else {
    // priority: overdue first, then stage importance, then balance
    const stageOrder = { cerceve:0, bozuldu:1, soz:2, ilk:3, x:4 };
    list.sort((a,b)=>{
      const ao = isOverdue(a)?0:1;
      const bo = isOverdue(b)?0:1;
      if (ao!==bo) return ao-bo;
      const as = stageOrder[String(a.stage||"").toLowerCase()] ?? 99;
      const bs = stageOrder[String(b.stage||"").toLowerCase()] ?? 99;
      if (as!==bs) return as-bs;
      return Math.abs(num(b.balance)) - Math.abs(num(a.balance));
    });
  }

  $("total").textContent = "Toplam: " + list.length + " dosya";
  renderCards(list);
}

function renderCards(list){
  const grid = $("grid");
  grid.innerHTML = "";

  list.forEach(c => {
    const overdue = isOverdue(c);

    const ownerName = (String(c.owner_name || "").trim()) || String(c.owner_user_id || "").trim() || "-";

    const el = document.createElement("div");
    el.className = "card";

    const balance = num(c.balance);
    const overdueBal = num(c.overdue_balance);
    const debt = num(c.debt_amount);
    const credit = num(c.credit_amount);

    const typeGroup = [String(c.type_code||"").trim(), String(c.group_code||"").trim()].filter(Boolean).join(" / ");

    el.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl font-bold text-zinc-100">${escapeHtml(c.account_name || "-")}</div>

          <div class="text-sm text-zinc-400 mt-1">
            <span class="mono">${escapeHtml(c.account_code || "-")}</span>
            ${typeGroup ? `<span class="mx-2">•</span><span class="mono text-zinc-500">${escapeHtml(typeGroup)}</span>` : ``}
            <span class="mx-2">•</span>
            <span class="inline-flex items-center gap-2">
              <span class="stageDot ${stageDotClass(c.stage)}"></span>
              <span>${escapeHtml(stageLabel(c.stage))}</span>
            </span>
          </div>

          <div class="text-xs text-zinc-500 mt-2">Sorumlu: <span class="text-zinc-300">${escapeHtml(ownerName)}</span></div>
        </div>

        <div class="text-right">
          <div class="text-lg font-bold text-zinc-100">${moneyTRY(balance)}</div>
          <div class="text-xs ${overdue ? "text-rose-300" : "text-zinc-500"}">
            ${overdue ? ("Geciken: " + moneyTRY(overdueBal)) : "Geciken: —"}
          </div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
        <div class="text-zinc-400">
          Borç: <span class="text-zinc-200 mono">${moneyTRY(debt)}</span>
        </div>
        <div class="text-zinc-400 text-right">
          Alacak: <span class="text-zinc-200 mono">${moneyTRY(credit)}</span>
        </div>
      </div>

      <div class="mt-3 flex items-center justify-between text-sm">
        <div class="text-zinc-400">
          Son Tahsilat: <span class="text-zinc-200 mono">${escapeHtml(c.last_collection_date || "-")}</span>
        </div>
        <div class="text-zinc-400">
          Erteleme: <span class="text-zinc-200 mono">${num(c.postpone_used)}/${num(c.postpone_limit)}</span>
        </div>
      </div>

      ${c.lock_reason ? `<div class="mt-2 text-sm text-amber-300">Kilit: <span class="mono">${escapeHtml(c.lock_reason)}</span></div>` : ``}
    `;

    el.addEventListener("click", ()=> {
      window.location.href = DETAIL_PAGE + "?case_id=" + encodeURIComponent(c.case_id);
    });

    grid.appendChild(el);
  });

  if (!list.length){
    const empty = document.createElement("div");
    empty.className = "text-sm text-zinc-500";
    empty.textContent = "Sonuç bulunamadı.";
    grid.appendChild(empty);
  }
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function init(){
  session = loadSession();
  if (!session || !session.user || !session.token){
    window.location.href = LOGIN_PAGE;
    return;
  }

  $("who").textContent = `${session.user.full_name} = ${session.user.role} • ${session.user.team}`;

  $("btnLogout").addEventListener("click", ()=>{
    clearSession();
    window.location.href = LOGIN_PAGE;
  });

  // close modals
  $("btnCloseNewCase").addEventListener("click", ()=>closeModal("modalNewCase"));
  $("modalNewCase").addEventListener("click", (e)=>{ if (e.target === $("modalNewCase")) closeModal("modalNewCase"); });

  $("btnCloseNewCollector").addEventListener("click", ()=>closeModal("modalNewCollector"));
  $("modalNewCollector").addEventListener("click", (e)=>{ if (e.target === $("modalNewCollector")) closeModal("modalNewCollector"); });

  // NEW CASE
  $("btnNewCase").addEventListener("click", async ()=>{
    try{
      if (!isMainAdmin()){
        toast("Sadece ana admin yeni dosya oluşturabilir.");
        return;
      }
      openModal("modalNewCase");
      await loadCollectorsIntoSelect();
    } catch(e){
      alert("Hata: " + (e.message || e));
    }
  });

  $("btnCreateCase").addEventListener("click", async ()=>{
    try{
      if (!isMainAdmin()){
        toast("Yetkiniz yok.");
        return;
      }

      // Customer columns (snake_case mapping used in backend)
      const account_code = ($("nc_account_code").value || "").trim();
      const account_name = ($("nc_account_name").value || "").trim();
      const type_code    = ($("nc_type_code").value || "").trim();
      const group_code   = ($("nc_group_code").value || "").trim();

      const debt_amount  = ($("nc_debt_amount").value || "").trim();
      const credit_amount= ($("nc_credit_amount").value || "").trim();
      const balance      = ($("nc_balance").value || "").trim();

      const customer_risk = ($("nc_customer_risk").value || "").trim();
      const own_risk      = ($("nc_own_risk").value || "").trim();

      const avg_debt_maturity    = ($("nc_avg_debt_maturity").value || "").trim();
      const avg_credit_maturity  = ($("nc_avg_credit_maturity").value || "").trim();
      const avg_balance_maturity = ($("nc_avg_balance_maturity").value || "").trim();
      const avg_collection_time  = ($("nc_avg_collection_time").value || "").trim();

      const last_collection_date   = ($("nc_last_collection_date").value || "").trim();
      const last_collection_amount = ($("nc_last_collection_amount").value || "").trim();
      const last_collection_type   = ($("nc_last_collection_type").value || "").trim();

      const last_30d_sales = ($("nc_last_30d_sales").value || "").trim();
      const days_since_last_collection = ($("nc_days_since_last_collection").value || "").trim();

      const email = ($("nc_email").value || "").trim();
      const overdue_wait_days = ($("nc_overdue_wait_days").value || "").trim();
      const overdue_balance   = ($("nc_overdue_balance").value || "").trim();

      const days_since_last_payment = ($("nc_days_since_last_payment").value || "").trim();
      const last_payment_amount     = ($("nc_last_payment_amount").value || "").trim();

      // System columns
      const owner_user_id  = ($("nc_owner_user_id").value || "").trim();
      const due_date       = ($("nc_due_date").value || "").trim();
      const phone          = ($("nc_phone").value || "").trim();
      const postpone_limit = ($("nc_postpone_limit").value || "").trim();

      if (!account_code || !account_name || !owner_user_id || !due_date){
        alert("Zorunlu: Hesap Kodu, Hesap Adı, Owner, Due Date");
        return;
      }

      const u = session.user;

      // defaults
      const sms_state = "NEW";
      const is_paid = "FALSE";

      const resp = await apiPost({
        action: "createCase",
        user_id: u.user_id,
        role: u.role,
        team: u.team,
        token: session.token,

        account_code,
        account_name,
        type_code,
        group_code,

        debt_amount,
        credit_amount,
        balance,

        customer_risk,
        own_risk,

        avg_debt_maturity,
        avg_credit_maturity,
        avg_balance_maturity,
        avg_collection_time,

        last_collection_date,
        last_collection_amount,
        last_collection_type,

        last_30d_sales,
        days_since_last_collection,

        email,
        overdue_wait_days,
        overdue_balance,

        days_since_last_payment,
        last_payment_amount,

        owner_user_id,
        due_date,
        phone,
        postpone_limit,

        sms_state,
        is_paid
      });

      if (!resp.ok) throw new Error(resp.error || "createCase failed");

      toast("Dosya oluşturuldu + SMS gönderildi");
      closeModal("modalNewCase");

      await loadCases();
      buildOwnerFilter();
      applyFilters();

    } catch(e){
      alert("Hata: " + (e.message || e));
    }
  });

  // NEW COLLECTOR
  $("btnNewCollector").addEventListener("click", ()=>{
    if (!isMainAdmin()){
      toast("Sadece admin tahsilatçı ekleyebilir.");
      return;
    }
    $("nu_full_name").value = "";
    $("nu_email").value = "";
    $("nu_phone").value = "";
    $("nu_team").value = "";
    openModal("modalNewCollector");
  });

  $("btnCreateCollector").addEventListener("click", async ()=>{
    try{
      if (!isMainAdmin()){
        toast("Yetkiniz yok.");
        return;
      }

      const full_name = ($("nu_full_name").value || "").trim();
      const email = ($("nu_email").value || "").trim().toLowerCase();
      const phone = ($("nu_phone").value || "").trim();
      const team_new = ($("nu_team").value || "").trim() || (session?.user?.team || "");

      if (!full_name) { alert("Zorunlu: Ad Soyad"); return; }
      if (!email) { alert("Zorunlu: E-posta"); return; }
      if (!phone) { alert("Zorunlu: Telefon"); return; }

      const u = session.user;

      const resp = await apiPost({
        action: "createCollector",
        user_id: u.user_id,
        role: u.role,
        team: u.team,
        token: session.token,
        full_name,
        email,
        phone,
        team_new
      });

      if (!resp.ok) throw new Error(resp.error || "createCollector failed");

      toast("Tahsilatçı oluşturuldu. Şifre SMS ile gönderildi.");
      closeModal("modalNewCollector");

      try { await loadCollectorsIntoSelect(); } catch {}

    } catch(e){
      alert("Hata: " + (e.message || e));
    }
  });

  $("btnRefresh").addEventListener("click", async ()=>{
    try{
      await loadCases();
      buildOwnerFilter();
      applyFilters();
      toast("Yenilendi");
    } catch(e){
      alert("Hata: " + (e.message || e));
    }
  });

  $("fStage").addEventListener("change", applyFilters);
  $("fOwner").addEventListener("change", applyFilters);
  $("fBroken").addEventListener("change", applyFilters);
  $("fSort").addEventListener("change", applyFilters);
  $("fSearch").addEventListener("input", applyFilters);

  $("tOverdue").addEventListener("click", ()=>{
    $("tOverdue").classList.toggle("on");
    applyFilters();
  });

  try {
    await loadCases();
    buildOwnerFilter();
    applyFilters();
  } catch (e){
    alert("Hata: " + (e.message || e));
  }
}

init();
</script>
</body>
</html>
